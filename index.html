<!DOCTYPE html>
<html>
<style>
    .container1 {
        float: left;
    }

    .container2 {
        float: right;
    }

    .container1.5 {
        margin-right: auto;
        margin-left: auto;
    }
</style>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
    <div class="container1" id="chart1"></div>
    <div class="container1.5" id="centerArea"></div>
    <div class="container2" id="chart2"></div>
</body>
<script>
    // Code taken and modified from: https://codepen.io/VividD/pen/bNgGKP
    var board = [];
    var colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    var domainData = ["A", "B", "C", "d", "E", "F", "G", "H", "I", "J"];
    var nextMove = [{ m: "D2", bw: 33, ww: 40, t: 33 }, { m: "C2", bw: 15, ww: 80, t: 5 }, { m: "D8", bw: 5, ww: 75, t: 20 }];
    var firstView, secondView, thirdView, fourthView;
    var posChar = ["H", "G", "F", "E", "D", "C", "B", "A"]
    var count = 8;
    var factor = 2;
    var tempCount = 8;
    var lastChar = "a";
    var colCount = 1;
    var pieceCount = 0;
    var index = 0;
    var div;
    var svg;
    var selected;
    var selectedText;
    var dy = 35;
    var dx = 20;
    var piece;
    var marginTop = 30,
        marginLeft = 30,
        fieldSize = 40 * factor,
        boardDimension = 8,
        boardSize = boardDimension * fieldSize;


    parseJson();
    makeChessBoard();
    setUpMutiWindow();
    function makeChessBoard() {

        for (var i = 0; i < boardDimension * boardDimension; i++) {
            board.push({
                x: i % boardDimension,
                y: Math.floor(i / boardDimension),
                piece: 0
            });
        };

        div = d3.select("#chart1")
            .style("height", ((fieldSize * fieldSize) / 10) + "px")
            .style("width", ((fieldSize * fieldSize) / 10) + "px")
            .append("div");


        svg = div.append("svg")
            .attr("width", boardSize + "px")
            .attr("height", boardSize + "px")
            .append("g");

        svg.selectAll("rect")
            .data(board)
            .enter()
            .append("rect")
            .attr("id",
                function () {
                    count--;
                    var tCount = count;
                    var tCol = tempCount;
                    if (count == 0) {
                        tempCount--;
                        count = 8;
                    }
                    return posChar[tCount] + (tCol);
                })
            .attr("x", function (d) {
                return d.x * fieldSize;
            })
            .attr("y", function (d) {
                return d.y * fieldSize;
            })
            .attr("width", fieldSize + "px")
            .attr("height", fieldSize + "px")
            .style("fill", function (d) {
                if (((d.x % 2 == 0) && (d.y % 2 == 0)) ||
                    ((d.x % 2 == 1) && (d.y % 2 == 1)))
                    return "beige";
                else
                    return "tan";
            })
            .on("click", function () {
                var dx = d3.select(this).attr("x");
                var dy = d3.select(this).attr("y");
                findandSetNewPiece(selected, d3.select(this).attr("id"))
                var thisPiece = d3.select("#" + selected);
                var thisPieceX = d3.select("#" + selectedText).attr("x", (20 * factor));
                var thisPieceY = d3.select("#" + selectedText).attr("y", (30 * factor));
                thisPiece.attr("transform", "translate(" + (dx) + ", " + (dy) + ")");
            });

        var chessPiece = svg.selectAll("text")
            .data(piece)
            .enter()
            .append("g")
            .attr("id", function (d) {
                var dy = d3.select("#" + d.p).attr("y");
                var dx = d3.select("#" + d.p).attr("x");
                board.forEach(function (i) {
                    if ((i.x * fieldSize) == dx && (i.y * fieldSize) == dy) {
                        i.piece = d.n;
                    }
                })
                return d.n;
            })
            .attr("transform", "translate(0,0)")
            .on("click", function () { selected = d3.select(this).attr("id") });

        chessPiece.append("text")
            .style("font-size", function () { return (30 * factor); })
            .attr("id", function (d) { return "text" + d.n; })
            .attr("text-anchor", "middle")
            .text(function (d) { return d.c; })
            .attr("y", function (d) { return +d3.select("#" + d.p).attr("y") + (30 * factor) })
            .attr("x", function (d) { return +d3.select("#" + d.p).attr("x") + (20 * factor); })
            .on("click", function () { selectedText = d3.select(this).attr("id") });
    }

    function findandSetNewPiece(pieceName, newLoc) {
        piece.forEach(function (i) {
            if (pieceName == i.n) {
                i.p = newLoc
            }
        })
    }

    //TODO: Parse json to place pieces
    function parseJson() {
        piece = [{ n: "bRook1", p: "A8", c: "\u265C" },
        { n: "bKnight1", p: "B8", c: "\u265E" }, { n: "bBishop1", p: "C8", c: "\u265D" },
        { n: "bKing", p: "D8", c: "\u265A" }, { n: "bQueen", p: "E8", c: "\u265B" },
        { n: "bBishop2", p: "F8", c: "\u265D" }, { n: "bKnight2", p: "G8", c: "\u265E" },
        { n: "bRook2", p: "H8", c: "\u265C" }, { n: "bPawn1", p: "A7", c: "\u265F" },
        { n: "bPawn2", p: "B7", c: "\u265F" }, { n: "bPawn3", p: "C7", c: "\u265F" },
        { n: "bPawn4", p: "D7", c: "\u265F" }, { n: "bPawn5", p: "E7", c: "\u265F" },
        { n: "bPawn6", p: "F7", c: "\u265F" }, { n: "bPawn7", p: "G7", c: "\u265F" },
        { n: "bPawn8", p: "H7", c: "\u265F" },
        { n: "wPawn1", p: "A2", c: "\u2659" }, { n: "wPawn2", p: "B2", c: "\u2659" },
        { n: "wPawn3", p: "C2", c: "\u2659" }, { n: "wPawn4", p: "D2", c: "\u2659" },
        { n: "wPawn5", p: "E2", c: "\u2659" }, { n: "wPawn6", p: "F2", c: "\u2659" },
        { n: "wPawn7", p: "G2", c: "\u2659" }, { n: "wPawn8", p: "H2", c: "\u2659" },
        { n: "wRook1", p: "A1", c: "\u2656" },
        { n: "wKnight1", p: "B1", c: "\u2658" }, { n: "wBishop1", p: "C1", c: "\u2657" },
        { n: "wKing", p: "D1", c: "\u2654" }, { n: "wQueen", p: "E1", c: "\u2655" },
        { n: "wBishop2", p: "F1", c: "\u2657" }, { n: "wKnight2", p: "G1", c: "\u2658" },
        { n: "wRook2", p: "H1", c: "\u2656" }];

    }



    function updateBoard() {

    }
    function setUpMutiWindow() {

        var infoView = d3.select("#chart2")
            .style("height", ((fieldSize * fieldSize) / 10) + "px")
            .style("width", ((fieldSize * fieldSize) / 10 + 120) + "px")
            .style("margin-right", "100px")
            .style("background-color", "lightgrey")
        var  svg = infoView.append("svg")
                           .attr("height", ((fieldSize * fieldSize) / 10))
                           .attr("width", ((fieldSize * fieldSize) / 10 + 120));


        firstView = svg.append("g")
            .attr("transform", "translate(12, 14)");
        firstView.append("rect")
            .attr("id", "firstView")
            .attr("fill", "white")
            .attr("height", ((fieldSize * fieldSize) / 40))
            .attr("width", ((fieldSize * fieldSize) / 8.7));


        secondView = svg.append("g")
            .attr("transform", "translate(12, 184)");
        secondView.append("rect")
            .attr("id", "secondView")
            .attr("fill", "white")
            .attr("height", ((fieldSize * fieldSize) / 30))
            .attr("width", ((fieldSize * fieldSize) / 8.7));

        thirdView = svg.append("g")
            .attr("transform", "translate(12, 409)");
        thirdView.append("rect")
            .attr("id", "thirdView")
            .attr("fill", "white")
            .attr("height", ((fieldSize * fieldSize) / 30))
            .attr("width", ((fieldSize * fieldSize) / 18))
			.style("overflow", "auto");

        fourthView = svg.append("g")
            .attr("transform", "translate(392, 409)");
        fourthView.append("rect")
            .attr("id", "fourthView")
            .attr("fill", "white")
            .attr("height", ((fieldSize * fieldSize) / 30))
            .attr("width", ((fieldSize * fieldSize) / 18))
			.style("overflow", "auto");

    }

    createBarChart();
    createPieChart();
    //Side box stuff
    function randNum(max, min) {
        var value = Math.floor(Math.random() * (+max - +min)) + +min;
        return value;
    }
    function createBarChart() {
        var secViewwidth = ((fieldSize * fieldSize) / 8.7) - 200;
        var secViewheight = ((fieldSize * fieldSize) / 30) - 31;
        var xScale = d3.scaleBand().range([0, 500]).padding(0.2);
        var yScale = d3.scaleLinear().range([300, 120]);

        var domainData = [];
        nextMove.forEach(function (i) {
            domainData.push(i.m);
        });



        xScale.domain(domainData);
        yScale.domain([0, 150]);

        var graph = secondView.append("g")
            .attr("class", "graph")
            .attr("transform", "translate(100, -5)");

        graph.append("rect")
            .attr("height", secViewheight)
            .attr("width", secViewwidth)
            .attr("transform", "translate(0, 20)")
            .attr("fill", "lightgrey")
            .attr("opacity", 0.4);

        graph.append("g")
            .attr("transform", "translate(0,200)")
            .call(d3.axisBottom(xScale)
                .tickSize(0));

        graph.append("g")
            .attr("class", "grid")
            .attr("transform", "translate(0,-100)")
            .call(d3.axisLeft(yScale)
                .tickSize(-secViewwidth))


        var bar = graph.selectAll("rect.m").data(nextMove)
            .enter()
            .append("rect")
            .style("fill", function (d, i) { return colorScale(i); })
            .attr("stroke", "black")
            .attr("id", function (d) { console.log(d); return d.m; })
            .attr("x", function (d) { return xScale(d.m); })
            .attr("y", function (d) { return yScale(d.ww) - 100; })
            .attr('height', function (d) { return 300 - yScale(d.ww); })
            .attr('width', xScale.bandwidth());

    }

    function createPieChart() {

        var sampleData = [];
        var loev = [];

        //console.log(domainData);
        domainData.forEach(function (i) {
            var v = randNum(78, 6);
            var total = 200;
            while (loev.includes(v)) {
                v = randNum(78, 6);
            }
            loev.push(v);
            sampleData.push({ length: v, name: i, count: v, value: v, axis: i });
        });

        var pie = d3.pie()
            .value(function (d) { return d.count; })
            .sort(null)
            (sampleData);

        var arc = d3.arc()
            .innerRadius(0)
            .outerRadius(90);

        var graph = thirdView.append("svg")
            .attr("class", "graph")
			.attr("height", ((fieldSize * fieldSize) / 30))
			.attr("width", ((fieldSize * fieldSize) / 18))
            <!-- .attr("transform", "translate(175, 110)"); -->


        var piecharts = graph.selectAll("path")
            .data(pie)
            .enter()
            .append("path")
            .attr("d", arc)
            .attr("id", function (i) { return i.data.name; })
            .attr("stroke", "black")
            .attr("fill", function (d, i) {
                return colorScale(i);
            });
		piecharts.attr("transform", "translate(175, 110)")
    }
	
	testFunction();
	
	function testFunction(d){
	    var t = d3.transition().duration(3000);
		var button = firstView.append("rect")
		                      .attr("height", 50)
							  .attr("width", 50)
							  .attr("fill", "red")
							  .attr("transform", "translate(20, 20)")
							  <!-- .on("click", function(){testPostRq();}) -->
							  .on("click", function(){
								var dx = d3.select("#G3").attr("x") - (d3.select("#textbKnight2").attr("x") - (20 * factor));
								var dy = d3.select("#G3").attr("y") - (d3.select("#textbKnight2").attr("y") - (30 * factor));
								var dir = "translate(" + dx + ", " + dy + ")" 
								d3.select("#bKnight2").transition(t).attr("transform", dir);
							  })
	}
	
	function testPostRq(){
        submitURL = "http://ashaji.dyn.wpi.edu:5000/getmoves"
        var postReq = "Hello Server. Give me some moves";
        console.log("JS of req:" + JSON.stringify(postReq));
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/getmoves", true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        console.log(submitURL);
        xhr.send(JSON.stringify(postReq));
        console.log(xhr);
        xhr.onloadend = function () {
            console.log(xhr);
            if (xhr.readyState == XMLHttpRequest.DONE) {
                console.log("XHR:" + xhr.responseText);
                console.log(xhr.responseText);
            } else {
                alert("Did not get response, server is down?")
            }
        }
	}
</script>
</html>