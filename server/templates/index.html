<!DOCTYPE html>
<html>
<style>
    .container1 {
        float: left;
    }

    .container2 {
        float: right;
    }

    .container1.5 {
        margin-right: auto;
        margin-left: auto;
    }
	
	#fourthView th div{
		position: absolute;
		margin-top: -31px;
		background-color: white;
	}
	
	#fourthView table { 
		border-collapse: collapse; 
	}
	
	#fourthView tbody { 
		border-top: 5px solid transparent;
	}
	
	.selected{
        opacity: 0.5;
	}
</style>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
    <div class="container1" id="chart1"></div>
    <div class="container1.5" id="centerArea"></div>
    <div class="container2" id="chart2"></div>
</body>
<script>
   
    var url = "http://ashaji.dyn.wpi.edu:5000"
    var board = [];
	var xAxis = [{move: "C6", win: 30, lose: 70}, 
		{move: "C4", win: 60, lose: 40}, 
		{move: "C5", win: 70, lose: 30},
		{move: "C9", win: 70, lose: 30},
		{move: "C7", win: 70, lose: 30},
		{move: "H5", win: 70, lose: 30},
		{move: "A7", win: 60, lose: 40}];
		
    var colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    var domainData = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j"];
    var nextMove = [{ m: "D2", bw: 33, ww: 40, t: 33 }, { m: "C2", bw: 15, ww: 80, t: 5 }, { m: "D8", bw: 5, ww: 75, t: 20 }];
    var firstView, secondView, thirdView, fourthView;
    var posChar = ["h", "g", "f", "e", "d", "c", "b", "a"]
    var count = 8;
    var factor = 2;
    var tempCount = 8;
    var lastChar = "a";
    var colCount = 1;
    var pieceCount = 0;
    var index = 0;
    var div;
    var svg;
    var selected;
	var selectedPiece;
    var selectedText;
    var dy = 35;
    var dx = 20;
    var piece;
    var marginTop = 30,
        marginLeft = 30,
        fieldSize = 40 * factor,
        boardDimension = 8,
        boardSize = boardDimension * fieldSize;

	var xLineValue;
    var xLineScale;
	var yLineScale;
		
    parseJson();
    makeChessBoard();
    setUpMutiWindow();
	setMoveText();
	historyTable();
	createBarChart();
	createPieChart();
	createLineChart();
    function parseJson() {
        piece = [{ n: "bRook1", p: "a8", c: "\u265C" },
        { n: "bKnight1", p: "b8", c: "\u265E" }, { n: "bBishop1", p: "c8", c: "\u265D" },
        { n: "bKing", p: "d8", c: "\u265A" }, { n: "bQueen", p: "e8", c: "\u265B" },
        { n: "bBishop2", p: "f8", c: "\u265D" }, { n: "bKnight2", p: "g8", c: "\u265E" },
        { n: "bRook2", p: "h8", c: "\u265C" }, { n: "bPawn1", p: "a7", c: "\u265F" },
        { n: "bPawn2", p: "b7", c: "\u265F" }, { n: "bPawn3", p: "c7", c: "\u265F" },
        { n: "bPawn4", p: "d7", c: "\u265F" }, { n: "bPawn5", p: "e7", c: "\u265F" },
        { n: "bPawn6", p: "f7", c: "\u265F" }, { n: "bPawn7", p: "g7", c: "\u265F" },
        { n: "bPawn8", p: "h7", c: "\u265F" },
        { n: "wPawn1", p: "a2", c: "\u2659" }, { n: "wPawn2", p: "b2", c: "\u2659" },
        { n: "wPawn3", p: "c2", c: "\u2659" }, { n: "wPawn4", p: "d2", c: "\u2659" },
        { n: "wPawn5", p: "e2", c: "\u2659" }, { n: "wPawn6", p: "f2", c: "\u2659" },
        { n: "wPawn7", p: "g2", c: "\u2659" }, { n: "wPawn8", p: "h2", c: "\u2659" },
        { n: "wRook1", p: "a1", c: "\u2656" },
        { n: "wKnight1", p: "b1", c: "\u2658" }, { n: "wBishop1", p: "c1", c: "\u2657" },
        { n: "wKing", p: "d1", c: "\u2654" }, { n: "wQueen", p: "e1", c: "\u2655" },
        { n: "wBishop2", p: "f1", c: "\u2657" }, { n: "wKnight2", p: "g1", c: "\u2658" },
        { n: "wRook2", p: "h1", c: "\u2656" }];

    }
	// Code taken and modified from: https://codepen.io/VividD/pen/bNgGKP
    function makeChessBoard() {

        for (var i = 0; i < boardDimension * boardDimension; i++) {
            board.push({
                x: i % boardDimension,
                y: Math.floor(i / boardDimension),
                piece: 0
            });
        };

        div = d3.select("#chart1")
            .style("height", ((fieldSize * fieldSize) / 10) + "px")
            .style("width", ((fieldSize * fieldSize) / 10) + "px")
            .append("div");


        svg = div.append("svg")
            .attr("width", boardSize + "px")
            .attr("height", boardSize + "px")
            .append("g");

        svg.selectAll("rect")
            .data(board)
            .enter()
            .append("rect")
            .attr("id",
                function () {
                    count--;
                    var tCount = count;
                    var tCol = tempCount;
                    if (count == 0) {
                        tempCount--;
                        count = 8;
                    }
                    return posChar[tCount] + (tCol);
                })
            .attr("x", function (d) {
                return d.x * fieldSize;
            })
            .attr("y", function (d) {
                return d.y * fieldSize;
            })
            .attr("width", fieldSize + "px")
            .attr("height", fieldSize + "px")
            .style("fill", function (d) {
                if (((d.x % 2 == 0) && (d.y % 2 == 0)) ||
                    ((d.x % 2 == 1) && (d.y % 2 == 1)))
                    return "beige";
                else
                    return "tan";
            })
            .on("click", function () {
                var dx = d3.select(this).attr("x");
                var dy = d3.select(this).attr("y");
                findandSetNewPiece(selected, d3.select(this).attr("id"))
                var thisPiece = d3.select("." + selected);
                var thisPieceX = d3.select("#" + selectedText).attr("x", (20 * factor));
                var thisPieceY = d3.select("#" + selectedText).attr("y", (30 * factor));
                thisPiece.attr("transform", "translate(" + (dx) + ", " + (dy) + ")");
            });

        var chessPiece = svg.selectAll("text")
            .data(piece)
            .enter()
            .append("g")
            .attr("class", function (d) {
                var dy = d3.select("#" + d.p).attr("y");
                var dx = d3.select("#" + d.p).attr("x");
                board.forEach(function (i) {
                    if ((i.x * fieldSize) == dx && (i.y * fieldSize) == dy) {
                        i.piece = d.n;
                    }
                })
                return d.n;
            })
            .attr("transform", "translate(0,0)")
            .on("click", function () { selected = d3.select(this).attr("class") });

        chessPiece.append("text")
            .style("font-size", function () { return (30 * factor); })
            .attr("id", function (d) { return d.n; })
            .attr("text-anchor", "middle")
            .text(function (d) { return d.c; })
            .attr("y", function (d) { return +d3.select("#" + d.p).attr("y") + (30 * factor) })
            .attr("x", function (d) { return +d3.select("#" + d.p).attr("x") + (20 * factor); })
			.on("mouseover", function(d){d3.select(this).style("cursor", "pointer");})
			.on("mouseout", function(d){d3.select(this).style("cursor", "default");}) 	
            .on("click", function () {
				selectedText = d3.select(this).attr("id");
				getPiece(selectedText);
				});
    }

	function findPiece(pieceName){
		piece.forEach(function (i) {
            if (pieceName == i.n) {
                return i.p;
            }
        })
	}
	
	function getPiece(pieceName){
		piece.forEach(function (i) {
            if (pieceName == i.n) {
                updateMoveText(i.c);
            }
        })
	}
    function findandSetNewPiece(pieceName, newLoc) {
        piece.forEach(function (i) {
            if (pieceName == i.n) {
                i.p = newLoc
            }
        })
    }
	
	function updateMoveText(s){
		d3.select("#pp").text(s);
	}
	
	//var testCount = 0;
	function updateMoveList(){
		var data = ["c4", "c5"]
		
		var listOfMoves = d3.select("#listBox");
		
		listOfMoves.selectAll("p").data(data).enter()
								  .append("p")
		                          .attr("id", function(d){return d;})
								  .style("display", "inline-block")
								  .style("margin-right", "10px")
								  .style("margin-top", "-5px")
								  .style("font-size", "14px")
								  .style("background-color", "lightgrey")
								  .style("border", "1px solid black")
								  .style("border-radius", "5px")
								  .text(function(d){return d;})
								  .on("click", function(){ 
										/*TODO make this grab all moves*/
										var d = d3.select(this).attr("id");
										//testCount++;
										updateLineChart({move: "g" + testCount, win: 30, lose: 70})
										getMoves(data);})
								  .on("mouseover", function(d){d3.select(this).style("cursor", "pointer");
								  d3.select(this).classed("selected", true);})
								  .on("mouseout", function(d){d3.select(this).style("cursor", "default");
								  d3.select(this).classed("selected", false);});
	}
	
	function updateLineChart(move){
		
		xAxis.push(move);
		d3.select("#svgLine").remove();
		createLineChart();
	
	}
	
	function createLineChart(){
		
		var svg = d3.select("#thirdView").append("svg")
											   .attr("id", "svgLine")
		                                       .attr("height", ((fieldSize * fieldSize) / 30))
											   .attr("width", ((fieldSize * fieldSize) / 8.7))
		
		var graph = svg.append("g")
					   .attr("id", "lineChart")
                       .attr("transform", "translate(100, 0)");
		
		var secViewwidth = ((fieldSize * fieldSize) / 18) - 200;
        var secViewheight = ((fieldSize * fieldSize) / 30) - 31;
		xLineValue = function(d) { return d.move;};
        xLineScale = d3.scalePoint().range([5, secViewwidth + 400]);
        yLineScale = d3.scaleLinear().range([300, secViewheight - 50]);
		
		xLineScale.domain(xAxis.map(xLineValue));
        yLineScale.domain([0, 100]);
		
		graph.append("g")
			.attr("id", "xLineAxis")
            .attr("transform", "translate(0,200)")
            .call(d3.axisBottom(xLineScale)
                .tickSize(0));

        graph.append("g")
            .attr("id", "grid")
            .attr("transform", "translate(0,-100)")
            .call(d3.axisLeft(yLineScale)
                .tickSize(-secViewwidth - 400))
		
		var wincircle = graph.selectAll("wcircle").data(xAxis)
            .enter()
            .append("circle")
            .style("fill", "green")
            .attr("stroke", "black")
			.attr("r", 4)
            .attr("cx", function (d) { return xLineScale(xLineValue(d)); })
            .attr("cy", function (d) { return yLineScale(d.win) - (100);})
		
		var losecircle = graph.selectAll("lcircle").data(xAxis)
            .enter()
            .append("circle")
            .style("fill", "red")
            .attr("stroke", "black")
			.attr("r", 4)
            .attr("cx", function (d) { return xLineScale(xLineValue(d)); })
            .attr("cy", function (d) { return yLineScale(d.lose) - (100);})
			
		var winline = d3.line()
					 .x(function (d) { return xLineScale(xLineValue(d)); })
					 .y(function (d) { return yLineScale(d.win) - (100);})
					 .curve(d3.curveMonotoneX)
					 
		var loseline = d3.line()
					 .x(function (d) { return xLineScale(xLineValue(d)); })
					 .y(function (d) { return yLineScale(d.lose) - (100);})
					 .curve(d3.curveMonotoneX)
		
		var wline = graph.append("path")
		     .datum(xAxis)
			 .attr("fill", "none")
			 .attr("stroke", "green")
		     .attr("class", "wline")
			 .attr("stroke-width", 2)
		     .attr("d", winline);
			 
		var lline = graph.append("path")
		     .datum(xAxis)
			 .attr("fill", "none")
			 .attr("stroke", "red")
			 .attr("stroke-width", 2)
		     .attr("class", "loseline")
		     .attr("d", loseline);

	}
	
	function setMoveText(){
		var v =  d3.select("#thirdandhalfView").append("div")
		                                       .style("height", ((fieldSize * fieldSize) / 40) + "px")
											   .style("width", ((fieldSize * fieldSize) / 36) - 20 + "px")
											   .style("float", "left");
		
		var view = v.append("svg")
		            .attr("height", ((fieldSize * fieldSize) / 40))
					.attr("width", ((fieldSize * fieldSize) / 36));
					
		var listView =  d3.select("#thirdandhalfView").append("div")
		                                          .style("height", ((fieldSize * fieldSize) / 40) + "px")
												  .style("width", ((fieldSize * fieldSize) / 36) + 20 + "px")
											      .style("float", "right");
		var textMove = view.append("text")
						   .attr("id", "moveText")
						   .attr("font-size", 20)
		                   .attr("transform", "translate(30, 30)")
						   .text("Current Piece");
						   
		var moveBox = view.append("rect")
						  .attr("id", "pieceBox")
		                  .attr("height", 70)
						  .attr("width", 70)
						  .attr("x", 45)
						  .attr("stroke", "black")
						  .attr("y", 55)
						  .attr("fill", "lightgrey")
						  .attr("opacity", 0.4);
						  
		var pieceBox = view.append("text")
						   .attr("x", function () { return +d3.select("#pieceBox").attr("x") + 35})
						   .attr("y", function () { return +d3.select("#pieceBox").attr("y") + 55})
						   .attr("text-anchor", "middle")
						   .attr("id", "pp")
						   .attr("font-size", 60)
						   .text("");
						   
		var lom = listView.append("p")
		                  .attr("id", "moveText")
						  .style("font-size", "123%")
		                  .style("margin-top", "12px")
						  .text("List of Next Moves");
						  
		var listBox = listView.append("div")
		                      .style("width", ((fieldSize * fieldSize) / 36) + "px")
							  .attr("id", "listBox")
							  .style("height", "65%")
							  .style("word-wrap", "break-word")
							  .style("overflow-y", "auto");
		updateMoveList();
	}
    function setUpMutiWindow() {

        var infoView = d3.select("#chart2")
            .style("height", ((fieldSize * fieldSize) / 10) + "px")
            .style("width", ((fieldSize * fieldSize) / 10 + 120) + "px")
            .style("margin-right", "100px")
            .style("background-color", "lightgrey")
		
		var firstView = infoView.append("div")
		                        .style("height", ((fieldSize * fieldSize) / 30) + "px")
                                .style("width", ((fieldSize * fieldSize) / 18) + "px")
								.attr("id", "firstView")
								.style("background-color", "white")
								.style("margin-left", "13px")
								.style("border-radius", "25px")
								.style("margin-top", "13px")
								.style("float", "left");
								
		var secondView = infoView.append("div")
		                        .style("height", ((fieldSize * fieldSize) / 30) + "px")
                                .style("width", ((fieldSize * fieldSize) / 18) + "px")
								.attr("id", "secondView")
								.style("background-color", "white")
								.style("border-radius", "25px")
								.style("margin-right", "13px")
								.style("margin-top", "13px")
								.style("float", "right");
								
		var thirdView = infoView.append("div")
		                        .style("height", ((fieldSize * fieldSize) / 30) + "px")
                                .style("width", ((fieldSize * fieldSize) / 8.7) + "px")
								.attr("id", "thirdView")
								.style("background-color", "white")
								.style("margin-left", "13px")
								.style("border-radius", "25px")
								.style("margin-top", "240px");
		
		var thirdandhalfView = infoView.append("div")
		                        .style("height", ((fieldSize * fieldSize) / 40) + "px")
                                .style("width", ((fieldSize * fieldSize) / 18) + "px")
								.attr("id", "thirdandhalfView")
								.style("background-color", "white")
								.style("margin-left", "13px")
								.style("border-radius", "25px")
								.style("margin-top", "13px")
								.style("float", "left");
								
		var fourthView = infoView.append("div")
		                        .style("height", ((fieldSize * fieldSize) / 40) + "px")
                                .style("width", ((fieldSize * fieldSize) / 18) + "px")
								.attr("id", "fourthView")
								.style("background-color", "white")
								.style("margin-right", "13px")
								.style("margin-top", "13px")
								.style("border-radius", "25px")
								.style("overflow", "auto")
								.style("float", "right");
    }
    function randNum(max, min) {
        var value = Math.floor(Math.random() * (+max - +min)) + +min;
        return value;
    }
    function createBarChart() {
        var secViewwidth = ((fieldSize * fieldSize) / 18) - 200;
        var secViewheight = ((fieldSize * fieldSize) / 30) - 31;
        var xScale = d3.scaleBand().range([0, secViewwidth + 100]).padding(0.2);
        var yScale = d3.scaleLinear().range([300, secViewheight - 50]);

        var domainData = [];
        nextMove.forEach(function (i) {
            domainData.push(i.m);
        });



        xScale.domain(domainData);
        yScale.domain([0, 150]);

        var svg = d3.select("#secondView").append("svg")
                                            .attr("class", "graph")
											.attr("height", ((fieldSize * fieldSize) / 30))
											.attr("width", ((fieldSize * fieldSize) / 18))
		var graph = svg.append("g")
                       .attr("transform", "translate(50, -10)");

        graph.append("rect")
            .attr("height", secViewheight - 10)
            .attr("width", secViewwidth + 100)
            .attr("transform", "translate(0, 30)")
            .attr("fill", "lightgrey")
            .attr("opacity", 0.4);

        graph.append("g")
            .attr("transform", "translate(0,200)")
            .call(d3.axisBottom(xScale)
                .tickSize(0));

        graph.append("g")
            .attr("class", "grid")
            .attr("transform", "translate(0,-100)")
            .call(d3.axisLeft(yScale)
                .tickSize(-secViewwidth - 100))


        var bar = graph.selectAll("rect.m").data(nextMove)
            .enter()
            .append("rect")
            .style("fill", function (d, i) { return colorScale(i); })
            .attr("stroke", "black")
            .attr("id", function (d) { console.log(d); return d.m; })
            .attr("x", function (d) { return xScale(d.m); })
            .attr("y", function (d) { return yScale(d.ww) - 100; })
            .attr('height', function (d) { return 300 - yScale(d.ww); })
            .attr('width', xScale.bandwidth());

    }

    function createPieChart() {

        var sampleData = [];
        var loev = [];

        //console.log(domainData);
        domainData.forEach(function (i) {
            var v = randNum(78, 6);
            var total = 200;
            while (loev.includes(v)) {
                v = randNum(78, 6);
            }
            loev.push(v);
            sampleData.push({ length: v, name: i, count: v, value: v, axis: i });
        });

        var pie = d3.pie()
            .value(function (d) { return d.count; })
            .sort(null)
            (sampleData);

        var arc = d3.arc()
            .innerRadius(0)
            .outerRadius(90);

        var graph = d3.select("#firstView").append("svg")
            .attr("class", "graph")
			.attr("height", ((fieldSize * fieldSize) / 30))
			.attr("width", ((fieldSize * fieldSize) / 18))

        var piecharts = graph.selectAll("path")
            .data(pie)
            .enter()
            .append("path")
            .attr("d", arc)
            .attr("id", function (i) { return i.data.name; })
            .attr("stroke", "black")
            .attr("fill", function (d, i) {
                return colorScale(i);
            });
		piecharts.attr("transform", "translate(175, 110)")
    }	
		
	function historyTable(){
		var sample = [[1,2,2,3],[1,2,2,3],[1,2,2,3],[1,2,2,3],[2,3,4,5],[2,3,4,5],[2,3,4,5],[2,3,4,5],[2,3,4,5],[2,3,4,5],[6,6,7,4],[9,0,8,6],[1,1,1,1],[1,9,9,6]];
		var table = d3.select("#fourthView").append("table")
		                                    .attr("id", "historyTable")
											.style("width", "80%")
											.style("margin-top", "30px")
											.style("margin-left", "40px");
											
		var header = table.append("tr");
		
		var th = header.selectAll("th")
			  .data(["Move", "Win%", "Lose%", "Tie%"])
			  .enter()
			  .append("th")
			  .append("div")
			  .style("text-align", "left")
			  .style("padding", "10px")
			  .text(function(d){return d;});
			  
		var bodyView = table.append("tbody");    
		
		var rows = bodyView.selectAll("tr")
		                   .data(sample)
						   .enter()
						   .append("tr")
						   .style("text-align", "center");
						   
		var values = rows.selectAll("td")
						 .data(function(d){return d;})
						 .enter()
						 .append("td")
						 .text(function(d){return d;});
	}
	
	function testFunction(d){
	
	    var t = d3.transition().duration(3000);
		var svg = d3.select("#firstView").append("svg")
		                                 .attr("height", ((fieldSize * fieldSize) / 30))
										 .attr("width",((fieldSize * fieldSize) / 8.7));
										 
		var button = svg.append("rect")
		                      .attr("height", 50)
							  .attr("width", 50)
							  .attr("fill", "red")
							  .attr("transform", "translate(20, 20)")
							  <!-- .on("click", function(){testPostRq();}) -->
							  .on("click", function(){
								var dx = d3.select("#G3").attr("x") - (d3.select("#textbBishop2").attr("x") - (20 * factor));
								var dy = d3.select("#G3").attr("y") - (d3.select("#textbBishop2").attr("y") - (30 * factor));
								var dir = "translate(" + dx + ", " + dy + ")" 
								d3.select("#bBishop2").transition(t).attr("transform", dir);
							  })
	}
	
	function getMoves(d){
        submitURL = url + "/getmoves"
        var postReq = {};
        postReq["moves"] = d;
        console.log("JS of req:" + JSON.stringify(postReq));
        var xhr = new XMLHttpRequest();
        xhr.open("POST", submitURL, true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        console.log(submitURL);
        xhr.send(JSON.stringify(postReq));
        console.log(xhr);
        xhr.onloadend = function () {
            console.log(xhr);
            if (xhr.readyState == XMLHttpRequest.DONE) {
                console.log("XHR:" + xhr.responseText);
                console.log(xhr.responseText);
            } else {
                alert("Did not get response, server is down?")
            }
        }
	}
</script>
</html>
